#!/usr/bin/env python

import cv2
import numpy as np

# ========================= Student's code starts here =========================

# Params for camera calibration
theta = 0.0150
beta = 720
tx = 0.2487
ty = 0.1270

# Function that converts image coord to world coord
def IMG2W(col, row):
    o_r = 240
    o_c = 320

    x_c = (1/beta) * (row - o_r) 
    y_c = (1/beta) * (col - o_c)

    x_w = np.cos(theta)*x_c - np.sin(theta)*y_c + tx
    y_w = np.sin(theta)*x_c + np.cos(theta)*y_c + ty

    return [x_w, y_w]

# ========================= Student's code ends here ===========================

def blob_search(image_raw, color):
    # FIXED: Initialize empty lists for ONLY the requested color
    color_keypoints = []
    color_xw_yw = []

    # Setup SimpleBlobDetector parameters.
    params = cv2.SimpleBlobDetector_Params()

    # ========================= Student's code starts here =========================

    # Filter by Color
    params.filterByColor = False

    # Filter by Area.
    params.filterByArea = True
    params.minArea = 100
    params.maxArea = 1000

    # Filter by Circularity
    params.filterByCircularity = False
    # Filter by Inertia
    params.filterByInertia = False
    # Filter by Convexity
    params.filterByConvexity = False

    # ========================= Student's code ends here ===========================

    # Create a detector with the parameters
    detector = cv2.SimpleBlobDetector_create(params)

    # Convert the image into the HSV color space
    hsv_image = cv2.cvtColor(image_raw, cv2.COLOR_BGR2HSV)

    # ========================= Student's code starts here =========================

    # Define color ranges for ALL colors we want to detect
    color_ranges = {
        "orange": ((5, 100, 100), (15, 255, 100)),
        "green": ((40, 50, 50), (90, 255, 255)),
        "yellow": ((10, 60, 60), (45, 255, 255))
    }
    
    # Define BGR colors for drawing keypoints (for visual distinction)
    color_bgr_map = {
        "orange": (255, 0, 0),   # blue in BGR
        "green": (0, 255, 0),    # Green in BGR  
        "yellow": (0, 0, 255)    # red in BGR
    }

    # FIXED: Initialize the image we'll draw all keypoints on
    im_with_all_keypoints = image_raw.copy()
    
    # FIXED: Create combined mask for display
    combined_mask = np.zeros((image_raw.shape[0], image_raw.shape[1]), dtype=np.uint8)
    
    # FIXED: Process EACH color but only return the requested one
    for color_name, (lower, upper) in color_ranges.items():
        # Create mask for this color
        mask = cv2.inRange(hsv_image, lower, upper)
        
        # Apply morphological operations to clean up the mask
        kernel = np.ones((7, 7), np.uint8)
        mask = cv2.morphologyEx(mask, cv2.MORPH_OPEN, kernel)
        mask = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel)

        combined_mask = cv2.bitwise_or(combined_mask, mask)
        
        # Detect keypoints for this color
        keypoints = detector.detect(mask)
        
        # FIXED: Draw keypoints for this color with its specific color (for visualization)
        if len(keypoints) > 0:
            im_with_all_keypoints = cv2.drawKeypoints(im_with_all_keypoints, keypoints, np.array([]), color_bgr_map[color_name], cv2.DRAW_MATCHES_FLAGS_DRAW_RICH_KEYPOINTS)
            
        # FIXED: Only convert to world coordinates and store for the REQUESTED color
        if color_name == color:
            for kp in keypoints:
                x_w, y_w = IMG2W(kp.pt[0], kp.pt[1])
                color_xw_yw.append((x_w, y_w))
                color_keypoints.append(kp)

    # combined_mask = np.zeros_like(mask)

    # for color_name, (lower, upper) in color_ranges.items():
    #     color_mask = cv2.inRange(hsv_image, lower, upper)
    #     kernel = np.ones((7, 7), np.uint8)
    #     color_mask = cv2.morphologyEx(color_mask, cv2.MORPH_OPEN, kernel)
    #     color_mask = cv2.morphologyEx(color_mask, cv2.MORPH_CLOSE, kernel)
    #     combined_mask = cv2.bitwise_or(combined_mask, color_mask)

    
    # FIXED: Print results for the requested color only
    if len(color_keypoints) == 0:
        print(f"No {color} blocks found!")
    else:
        print(f"Found {len(color_keypoints)} {color} blocks")

    # ========================= Student's code ends here ===========================

    cv2.namedWindow("Camera View")
    cv2.imshow("Camera View", image_raw)
    cv2.namedWindow("Mask View")
    cv2.imshow("Mask View", combined_mask)
    cv2.namedWindow("Keypoint View")
    cv2.imshow("Keypoint View", im_with_all_keypoints)

    cv2.waitKey(2)

    # FIXED: Return world coordinates for ONLY the requested color
    return color_xw_yw

# ========================= Student's code starts here =========================

# Z coordinate values
PICK_Z  = 0.02
PLACE_Z = 0.02

rospy.loginfo("Waiting for block detection")

# Wait until we have at least some blocks detected
while len(xw_yw_G) == 0 and len(xw_yw_Y) == 0:
    time.sleep(0.1)

# Save initial positions of ALL blocks with validation (CHANGED)
all_green_blocks = []
all_yellow_blocks = []

def is_valid_coordinate(x, y):
    """Check if coordinates are valid and within workspace (CHANGED)"""
    import math
    if math.isnan(x) or math.isnan(y):
        return False
    if abs(x) > 0.5 or abs(y) > 0.5:  # Rough workspace bounds
        return False
    return True

# Process green blocks with validation (CHANGED)
for i, block_pos in enumerate(xw_yw_G):
    if i < 2 and is_valid_coordinate(block_pos[0], block_pos[1]):
        all_green_blocks.append([block_pos[0], block_pos[1], PICK_Z])
    elif i < 2:
        print(f"WARNING: Skipping invalid green block at position {block_pos}")

# Process yellow blocks with validation (CHANGED)  
for i, block_pos in enumerate(xw_yw_Y):
    if i < 2 and is_valid_coordinate(block_pos[0], block_pos[1]):
        all_yellow_blocks.append([block_pos[0], block_pos[1], PICK_Z])
    elif i < 2:
        print(f"WARNING: Skipping invalid yellow block at position {block_pos}")

print(f"Found {len(all_green_blocks)} valid green blocks and {len(all_yellow_blocks)} valid yellow blocks")

# Define multiple goal positions (ensure they're reachable) (CHANGED)
green_goals = [
    [0.25, -0.10, PLACE_Z],  # Closer to center (CHANGED)
    [0.25, -0.20, PLACE_Z]   # Closer to center (CHANGED)
]

yellow_goals = [
    [0.25, 0.10, PLACE_Z],   # Closer to center (CHANGED)
    [0.25, 0.20, PLACE_Z]    # Closer to center (CHANGED)
]

# Move all green blocks with error handling (CHANGED)
for i, green_block in enumerate(all_green_blocks):
    if i < len(green_goals):
        print(f"Moving green block {i+1} from {green_block} to {green_goals[i]}")
        try:
            error = move_block(pub_command, loop_rate, green_block, green_goals[i], vel, accel)
            if error != 0:
                rospy.logerr(f"Failed to move green block {i+1}, error code: {error}")
            else:
                print(f"Successfully moved green block {i+1}")
        except Exception as e:
            rospy.logerr(f"Exception moving green block {i+1}: {e}")
        # Wait a bit between moves
        time.sleep(2.0)  # Increased delay (CHANGED)

# Return to go_away position between color groups (CHANGED)
move_arm(pub_command, loop_rate, go_away, vel, accel)
time.sleep(1.0)

# Move all yellow blocks with error handling (CHANGED)
for i, yellow_block in enumerate(all_yellow_blocks):
    if i < len(yellow_goals):
        print(f"Moving yellow block {i+1} from {yellow_block} to {yellow_goals[i]}")
        try:
            error = move_block(pub_command, loop_rate, yellow_block, yellow_goals[i], vel, accel)
            if error != 0:
                rospy.logerr(f"Failed to move yellow block {i+1}, error code: {error}")
            else:
                print(f"Successfully moved yellow block {i+1}")
        except Exception as e:
            rospy.logerr(f"Exception moving yellow block {i+1}: {e}")
        # Wait a bit between moves
        time.sleep(2.0)  # Increased delay (CHANGED)

# ========================= Student's code ends here ===========================

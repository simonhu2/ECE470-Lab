# Z coordinate values
PICK_Z  = 0.02
PLACE_Z = 0.02

rospy.loginfo("Waiting for block detection")

# CHANGED: Wait for initial detection and save positions immediately
while len(xw_yw_G) == 0 and len(xw_yw_Y) == 0:
    time.sleep(0.1)

# CHANGED: Save ORIGINAL block positions immediately after detection
original_green_blocks = []
original_yellow_blocks = []

def is_valid_coordinate(x, y):
    """Check if coordinates are valid and within workspace (CHANGED)"""
    import math
    if math.isnan(x) or math.isnan(y):
        return False
    if abs(x) > 0.5 or abs(y) > 0.5:
        return False
    return True

# CHANGED: Save green blocks from initial detection
for i, block_pos in enumerate(xw_yw_G):
    if i < 2 and is_valid_coordinate(block_pos[0], block_pos[1]):
        original_green_blocks.append([block_pos[0], block_pos[1], PICK_Z])
        print(f"Saved green block {i+1} at: ({block_pos[0]:.3f}, {block_pos[1]:.3f})")

# CHANGED: Save yellow blocks from initial detection  
for i, block_pos in enumerate(xw_yw_Y):
    if i < 2 and is_valid_coordinate(block_pos[0], block_pos[1]):
        original_yellow_blocks.append([block_pos[0], block_pos[1], PICK_Z])
        print(f"Saved yellow block {i+1} at: ({block_pos[0]:.3f}, {block_pos[1]:.3f})")

print(f"Initial detection: {len(original_green_blocks)} green, {len(original_yellow_blocks)} yellow blocks")

# CHANGED: Define goal positions with proper spacing
green_goals = [
    [0.25, -0.10, PLACE_Z],
    [0.25, -0.20, PLACE_Z]
]

yellow_goals = [
    [0.25, 0.10, PLACE_Z],
    [0.25, 0.20, PLACE_Z]
]

# CHANGED: Move ALL green blocks using original positions
for i, green_block in enumerate(original_green_blocks):
    if i < len(green_goals):
        print(f"Moving green block {i+1} from ({green_block[0]:.3f}, {green_block[1]:.3f}) to ({green_goals[i][0]:.3f}, {green_goals[i][1]:.3f})")
        try:
            error = move_block(pub_command, loop_rate, green_block, green_goals[i], vel, accel)
            if error != 0:
                rospy.logerr(f"Failed to move green block {i+1}, error code: {error}")
            else:
                print(f"Successfully moved green block {i+1}")
        except Exception as e:
            rospy.logerr(f"Exception moving green block {i+1}: {e}")
        # Wait between moves
        time.sleep(2.0)

# CHANGED: Return to safe position before moving yellow blocks
move_arm(pub_command, loop_rate, go_away, vel, accel)
time.sleep(1.0)

# CHANGED: Move ALL yellow blocks using original positions
for i, yellow_block in enumerate(original_yellow_blocks):
    if i < len(yellow_goals):
        print(f"Moving yellow block {i+1} from ({yellow_block[0]:.3f}, {yellow_block[1]:.3f}) to ({yellow_goals[i][0]:.3f}, {yellow_goals[i][1]:.3f})")
        try:
            error = move_block(pub_command, loop_rate, yellow_block, yellow_goals[i], vel, accel)
            if error != 0:
                rospy.logerr(f"Failed to move yellow block {i+1}, error code: {error}")
            else:
                print(f"Successfully moved yellow block {i+1}")
        except Exception as e:
            rospy.logerr(f"Exception moving yellow block {i+1}: {e}")
        # Wait between moves
        time.sleep(2.0)

PICK_Z  = 0.02
PLACE_Z = 0.02

rospy.loginfo("Waiting for block detection...")

# CHANGED: Wait longer and check both colors separately
detection_timeout = 10  # seconds
start_time = time.time()
green_detected = False
yellow_detected = False

while (time.time() - start_time) < detection_timeout:
    if len(xw_yw_G) > 0:
        green_detected = True
        print(f"Green blocks detected: {len(xw_yw_G)}")
    if len(xw_yw_Y) > 0:
        yellow_detected = True  
        print(f"Yellow blocks detected: {len(xw_yw_Y)}")
    if green_detected and yellow_detected:
        break
    time.sleep(0.5)

if not green_detected and not yellow_detected:
    rospy.logerr("No blocks detected after timeout! Check camera and colors.")
    # Continue anyway to see what happens

# CHANGED: Save current block positions
original_green_blocks = []
original_yellow_blocks = []

def is_valid_coordinate(x, y):
    """Check if coordinates are valid (CHANGED)"""
    if np.isnan(x) or np.isnan(y):
        return False
    if abs(x) > 0.5 or abs(y) > 0.5:  # Workspace bounds
        return False
    return True

# CHANGED: Save detected blocks with validation
print("=== SAVING BLOCK POSITIONS ===")
for i, block_pos in enumerate(xw_yw_G):
    if i < 2 and is_valid_coordinate(block_pos[0], block_pos[1]):
        original_green_blocks.append([block_pos[0], block_pos[1], PICK_Z])
        print(f"Green block {i+1}: ({block_pos[0]:.3f}, {block_pos[1]:.3f})")

for i, block_pos in enumerate(xw_yw_Y):
    if i < 2 and is_valid_coordinate(block_pos[0], block_pos[1]):
        original_yellow_blocks.append([block_pos[0], block_pos[1], PICK_Z])
        print(f"Yellow block {i+1}: ({block_pos[0]:.3f}, {block_pos[1]:.3f})")

print(f"TOTAL: {len(original_green_blocks)} green, {len(original_yellow_blocks)} yellow blocks")

# CHANGED: Define goal positions
green_goals = [
    [0.25, -0.10, PLACE_Z],
    [0.25, -0.20, PLACE_Z]
]

yellow_goals = [
    [0.25, 0.10, PLACE_Z],
    [0.25, 0.20, PLACE_Z]
]

# CHANGED: Move green blocks with detailed logging
if len(original_green_blocks) > 0:
    print("=== MOVING GREEN BLOCKS ===")
    for i, green_block in enumerate(original_green_blocks):
        if i < len(green_goals):
            print(f"Green {i+1}: ({green_block[0]:.3f}, {green_block[1]:.3f}) -> ({green_goals[i][0]:.3f}, {green_goals[i][1]:.3f})")
            try:
                error = move_block(pub_command, loop_rate, green_block, green_goals[i], vel, accel)
                if error == 0:
                    print(f"✓ Successfully moved green block {i+1}")
                else:
                    rospy.logerr(f"✗ Failed to move green block {i+1}, error: {error}")
            except Exception as e:
                rospy.logerr(f"✗ Exception moving green block {i+1}: {e}")
            time.sleep(2.0)
else:
    print("No green blocks to move")

# CHANGED: Return to safe position
move_arm(pub_command, loop_rate, go_away, vel, accel)
time.sleep(1.0)

# CHANGED: Move yellow blocks with detailed logging
if len(original_yellow_blocks) > 0:
    print("=== MOVING YELLOW BLOCKS ===")
    for i, yellow_block in enumerate(original_yellow_blocks):
        if i < len(yellow_goals):
            print(f"Yellow {i+1}: ({yellow_block[0]:.3f}, {yellow_block[1]:.3f}) -> ({yellow_goals[i][0]:.3f}, {yellow_goals[i][1]:.3f})")
            try:
                error = move_block(pub_command, loop_rate, yellow_block, yellow_goals[i], vel, accel)
                if error == 0:
                    print(f"✓ Successfully moved yellow block {i+1}")
                else:
                    rospy.logerr(f"✗ Failed to move yellow block {i+1}, error: {error}")
            except Exception as e:
                rospy.logerr(f"✗ Exception moving yellow block {i+1}: {e}")
            time.sleep(2.0)
else:
    print("No yellow blocks to move")

print("=== PICK AND PLACE COMPLETED ===")
